import{r as l,j as t,H as P}from"./app-CHQLiDLB.js";import{A as T}from"./AuthenticatedLayout-ClzveHc0.js";import{H as C}from"./html5-qrcode-scanner-uVCIMSOY.js";import{P as R}from"./PrimaryButton-M0zwo5CZ.js";import"./transition-QGCFaxmb.js";import"./ApplicationLogo-BC61OCTF.js";function Q(){const x="html5qr-code-full-region",a=l.useRef(null),[f,i]=l.useState(!1),[A,b]=l.useState(null),[d,M]=l.useState([]),[h,j]=l.useState(null),[E,y]=l.useState(!1),[v,o]=l.useState(null),[u,k]=l.useState(null);l.useEffect(()=>()=>{a.current&&a.current.stop().then(()=>{a.current.clear(),a.current=null}).catch(()=>{a.current=null})},[]);const N=async()=>C.getCameras().then(e=>(M(e||[]),e&&e.length>0&&!h&&j(e[0].deviceId||e[0].id),e)).catch(e=>{throw console.error("Error listing cameras",e),e}),w=async e=>{const m="/member/attend",g=document.querySelector('meta[name="csrf-token"]')?.getAttribute("content");try{y(!0),o(null),k(null);const r=await fetch(m,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":g},body:JSON.stringify({token:e})}),n=r.headers.get("content-type")||"";if(!r.ok){if(n.includes("application/json")){const s=await r.json().catch(()=>null);o(s?.message??`Server error ${r.status}`)}else{const s=await r.text().catch(()=>null);o(`Server error ${r.status}: ${s??"no details"}`)}return}if(n.includes("application/json")){const s=await r.json().catch(()=>null);o(s?.message??"Token terkirim"),s?.data&&k(s.data)}else{const s=await r.text().catch(()=>null);console.debug("Non-JSON response from /member/attend:",s),o("Token terkirim (server mengembalikan HTML).")}}catch(r){console.error("Failed to send token",r),o("Gagal mengirim token")}finally{y(!1)}},I=async()=>{if(!f)try{if(a.current){await a.current.stop().catch(()=>{});try{a.current.clear()}catch{}a.current=null}const e=new C(x);a.current=e;const m=h||d[0]&&(d[0].deviceId||d[0].id)||null,g=m||{facingMode:"environment"},r={fps:10,qrbox:300};try{await e.start(g,r,n=>{b(n),p(),w(n)},n=>{}),i(!0)}catch(n){console.error("Failed to start scanner",n);const s=n&&(n.name||""),S=n&&n.message||"";if(s==="NotReadableError"||S.includes("Could not start video source")||S.includes("NotReadableError")){console.warn("Camera busy or not readable â€” mencoba fallback facingMode in 500ms"),await new Promise(c=>setTimeout(c,500));try{await e.start({facingMode:"environment"},r,c=>{b(c),p(),w(c)},c=>{}),i(!0);return}catch(c){console.error("Fallback start also failed",c);try{await e.stop()}catch{}try{e.clear()}catch{}a.current=null;return}}try{await e.stop()}catch{}try{e.clear()}catch{}a.current=null}}catch(e){console.error("Failed to start scanner",e)}},p=()=>{if(!a.current){i(!1);return}a.current.stop().then(()=>{a.current.clear(),a.current=null,i(!1)}).catch(e=>{console.error("Failed to stop scanner",e),a.current=null,i(!1)})};return t.jsxs(T,{header:t.jsx("h2",{className:"text-xl font-semibold leading-tight text-primary",children:"Presensi"}),children:[t.jsx(P,{title:"Presensi"}),t.jsx("div",{className:"py-12",children:t.jsx("div",{className:"mx-auto max-w-7xl sm:px-6 lg:px-8",children:t.jsx("div",{className:"overflow-hidden bg-white shadow-sm sm:rounded-lg",children:t.jsxs("div",{className:"p-6 text-gray-900",children:[t.jsxs("div",{className:"mb-2 flex gap-2",children:[t.jsx(R,{type:"button",onClick:()=>{N().then(()=>I())},children:"Mulai Scan QR"}),t.jsx("button",{type:"button",onClick:p,disabled:!f,className:"px-3 py-2 bg-gray-600 text-white rounded disabled:opacity-50",children:"Stop"}),t.jsx(R,{type:"button",onClick:()=>{N()},children:"Refresh"})]}),d.length>0&&t.jsxs("div",{className:"mb-3",children:[t.jsx("label",{className:"block text-sm text-gray-700",children:"Pilih Kamera:"}),t.jsx("select",{value:h||"",onChange:e=>j(e.target.value),className:"mt-1 border rounded",children:d.map(e=>t.jsx("option",{value:e.deviceId||e.id,children:e.label||e.deviceId||e.id},e.deviceId||e.id))})]}),t.jsx("div",{id:x,className:"w-full max-w-md border rounded overflow-hidden"}),t.jsx("div",{className:"mt-3",children:E?t.jsx("div",{className:"text-sm text-blue-600",children:"Mengirim token..."}):v?t.jsx("div",{className:"text-sm text-green-600",children:v}):null}),u&&t.jsx("div",{className:"mt-4 p-4 border rounded bg-green-500",children:t.jsxs("p",{className:"text-base text-white font-regular",children:["Presensi atas nama"," ",t.jsx("span",{className:"font-bold",children:u.committee?.member?.name??"Nama"})," ","pada program kerja"," ",u.attendance_date?.event?.title??"Acara"," ","-"," ",u.attendance_date?.name??"Tanggal"," ","berhasil dilakukan."]})}),t.jsx("p",{className:"mt-3 text-sm text-gray-500",children:"Catatan: Presensi hanya dapat dilakukan jika kamu tergabung ke dalam kepanitiaan."})]})})})})]})}export{Q as default};
